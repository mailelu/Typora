# Services

* 如何和进程和服务交互?



## 什么是进程?

进程使一个进程和另一个正在执行的进程相互隔离

进程是电脑进行cpu资源,内存等资源分配的基本单元



# 进程的组成

* PID	: Process ID
* PPID  : Parent's ID
* UID	: Uer  running the process

一个程序正在运行的文件



# init

init是pc启动时第一个启动的计算机进程

* PID = 1
* 这个进程管理其他所有的进程
* 使用htop命令,在使用F5查看树形进程图

每个进程都是由父进程创造的,除了pid1



# 进程和线程的区别

一个进程可以有多个线程

* 多个线程共享一个内存

* 线程间可以直接通信



#为什么chrome有如此多的进程?



为了安全,如果一个选项卡受到攻击,我们只需要关闭其选项卡而不需要将整个程序关闭,如果某个进程崩溃,他不会影响其他进程



# 进程是如何创建的?

linux中有`fork`方法,如果你使用`fork(2)`,他将在父进程下创建两个子进程

* 父进程PID不变
* 子进程获得两个新PID
* 子进程将获得相互独立的内存



当然,我们也可以使用`exec`来创建一个新的进程

在Linux操作系统中,所有进程都有一个父进程(init进程除外),当我打开一个程序,只是在另一个程序中进行了一次fork()而已



```c
int main(void) {
    fork();
    fork();
    fork();
    print("hello:",getpid());
}
```

* 这段代码执行了fork(),分裂成8个相同的进程,这8个进程是完全相同且独立的
* 新创建的进程会从他创建的时候的代码开始运行

* 它不是单纯的复制代码,它复制了其内存块中的状态等等



# 进程炸弹(耗尽系统资源)

```shell
:(){ :|:& };:

 bomb (){
	bomb | bomb &
} bomb
```

* 两个典型的进程炸弹



```bash
:(){ :|:& };:
//	`:`定义了一个bash函数 :|:&
//	函数体中的`:`这是要给递归调用自身的命令
//	`|`管道操作符,将命令输出传递给另一个命令
//	`&`后台运行命令的符号
```



# 使用子进程



fork()的返回值是一个大于0的数

```bash
int main(void){
	if(fork() > 0){
		wait(NULL);
		//父进程
	}
	else{
	//子进程,fork()会创建一个子进程，如果在子进程中，返回值是0
	execv("/bin/bash",NULL);
	}//execv函数会加载一个新的程序
}
```



* 当一个程序运行结束但并没有被清理,它的数据仍然在数据表中



# 结束子进程



```bash
if (fork()>0){
	sleep(1);
}else{
	exit(1);
	//结束子进程,返回值在0~255之间,0表示成功
}
```

当父母进程比子进程先一步结束

* init进程会获取这些孤儿进程
* 当子进程被kill时,init会清除元数据



# 僵尸进程带来的问题

当父进程是一个长时间运行的进程,而父进程并没有使用wait() 等待子进程结束,此时子进程无法成为僵尸进程,无法被kill导致的**资源泄露**,占用系统内存



# 进程间通信

有很多种进程间通信的方式

1. 使用返回代码
2. 使用信号量(死亡标志,中断标志)

程序可以选择特定的信号量执行特定的命令,但是某些信号量不可以拒绝,比如死亡信号量

3. 管道通信
4. 嵌套子,常用在网络通信 



#什么是systemd

systemd是一种控制系统,以d结尾的程序一般是系统程序

我们可以通过init提供的控制代码控制systemd进程



下面将举例介绍systemd

## Systemd Unit Files

Systemd Unit Files定义了服务的一些行为

比如:服务如何开启?服务如何响应命令?



```bash
systemctl start [name]
systemctl stop [name]
systemctl restart [name] 
systemctl reload [name] //载入
systemctl enable[name]  //设置服务以管理员身份运行
systemctl disable [name]
```



# system CTL

system CTL提供了一系列的命令使用户可以查看正在运行的系统服务,并与之交互



## nginx and  httpd

nginx:

是一个高性能的开源Web服务器和反向代理服务器，它也可以用作负载均衡器和HTTP缓存服务器.可以侦听80端口并提供服务 





# Runit 

一种更好的init管理系统:

* 更小
* 理解你的命令



## runscidr

一个重要的组件，它用于监视指定目录下的服务（或服务定义），并在需要时启动、停止或重新启动这些服务。
